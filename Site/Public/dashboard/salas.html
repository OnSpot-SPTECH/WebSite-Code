<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Dashboard</title>

	<link rel="stylesheet" href="salas.css">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->

</head>

<body onload="obterDadosGraficos(1)">
	<!-- Header -->
	<header>
		<img class="img-logo" src="./img/Frame 12.svg" alt="">
		<!-- <a class="a_sala" onclick="fecharSalas()">Salas</a> -->
		<a id="headerTitulo" class="titulo_header">Salas</a>
	</header>

	<main>
		<nav class="nav_esquerda">
			<div class="div_salas">
				<ul class="ul_salas">

					<li>
						<a href="salas.html"><img src="./img/data-center.png"></img></a>
					</li>
					<li>
						<a href="../login.html"><img class="icone-logout" src="../assets/icone-logout.svg" alt=""></a>
					</li>
				</ul>
			</div>

		</nav>

		<div class="div_conteudo">

			<!-- <section class="squares_circles">
				
			</section> -->
			<div class="tituloInput">
				<span id="salasTitulo" class="salas_titulo">Clique na sala desejada</span>
				<div class="input-container">
					<input type="text" id="inputSalas" class="sala-input" placeholder="Sua sala">
				</div>
			</div>
			<section id="salas" class="main_salas">
				<div onclick="fecharSalas()" id="salaUm" class="salas">
					Sala 1
					<div class="img-alert">
						<img id="img1Sala1" src="">
						<img id="img2Sala1" src="">
					</div>
				</div>
				<div id="salaDois" class="salas">
					Sala 2
					<div class="img-alert">
						<img id="img3Sala2" src="">
						<img id="img4Sala2" src="">
					</div>
				</div>
				<div id="salaTres" class="salas">
					Sala 3
					<div class="img-alert">
						<img id="img5Sala3" src="">
						<img id="img6Sala3" src="">
					</div>
				</div>
				<div id="salaQuatro" class="salas">
					Sala 4
					<div class="img-alert">
						<img id="img7Sala4" src="">
						<img id="img8Sala4" src="">
					</div>
				</div>
			</section>

			<div id="divSala1" class="main_sala">
				<div class="racks">
					<div class="rack" id="rackUm">
						<div class="rack_main" id="rackMain">
							<h2 class="titulo_rack">Rack 1</h2>
							<div class="rack_nav" onclick="rack1()" id="rackNav1">
								<img src="./img/plus.png" alt="">
							</div>
							<div class="square square_umi">
								<div class="circle circle-umi">
									<div class="text">
										40%
									</div>
								</div>
								<div class="text2">
									<p>Umidade</p>
								</div>
							</div>
							<div class="square">
								<div class="circle circle-temp">
									<div class="text">
										40%
									</div>
								</div>
								<div class="text2">
									<p>Temperatura</p>
								</div>
							</div>
						</div>
						<div class="var_Sensores" id="varSensores">
							Temperatura
							<div class="barra_sensores"><span class="triangulo_sensor"></span></div>
							Umidade
							<div class="barra_sensores"><span class="triangulo_sensor"></span></div>
						</div>
						<div class="graficos_Racks" id="graficosRacks">
							<div class="grafico_Rack" id="graficoRack">
								<canvas class="grafico" id="grafico"></canvas>
							</div>
						</div>
					</div>
					<div class="rack" id="rackDois">
						<div class="rack_main" id="rackMain2">
							<h2 class="titulo_rack">Rack 2</h2>
							<div class="rack_nav" onclick="rack2()" id="rackNav2">
								<img src="./img/plus.png" alt="">
							</div>
							<div class="square square_umi">
								<div class="circle circle-umi">
									<div class="text">
										40%
									</div>
								</div>
								<div class="text2">
									<p>Umidade</p>
								</div>
							</div>
							<div class="square">
								<div class="circle circle-temp">
									<div class="text">
										40%
									</div>
								</div>
								<div class="text2">
									<p>Temperatura</p>
								</div>
							</div>
						</div>
						<div class="var_Sensores" id="varSensores2">
							Temperatura
							<div class="barra_sensores"><span class="triangulo_sensor"></span></div>
							Umidade
							<div class="barra_sensores"><span class="triangulo_sensor"></span></div>
						</div>
						<div class="graficos_Racks" id="graficosRacks2">
							<div class="grafico_Rack" id="graficoRack2">
								<canvas class="grafico" id="grafico2"></canvas>
							</div>
						</div>
					</div>
					<div class="rack" id="rackTres">
						<div class="rack_main" id="rackMain3">
							<h2 class="titulo_rack">Rack 3</h2>
							<div class="rack_nav" onclick="rack3()" id="rackNav3">
								<img src="./img/plus.png" alt="">
							</div>
							<div class="square square_umi">
								<div class="circle circle-umi">
									<div class="text">
										40%
									</div>
								</div>
								<div class="text2">
									<p>Umidade</p>
								</div>
							</div>
							<div class="square">
								<div class="circle circle-temp">
									<div class="text">
										40%
									</div>
								</div>
								<div class="text2">
									<p>Temperatura</p>
								</div>
							</div>
						</div>
						<div class="graficos_Racks" id="graficosRacks3">
							<div class="grafico_Rack" id="graficoRack3">
								<canvas class="grafico" id="grafico3"></canvas>
							</div>
						</div>
					</div>
				</div>
				<section class="analy-section">
					<h1> Legendas de alerta </h1>
					<div class="div1"> <img src="./img/Group 110.png"> </div>
				</section>
			</div>

	</main>
</body>

</html>

<!-- <script src="index.js"></script> -->
<script>

	console.log("antes da primeira funçao")
	function obterDadosGraficos(id) {
		console.log("entrei na primeira")

		fetch(`/dashboard/obterDadosGraficos/${id}`, { cache: 'no-store' }).then(function (response) {
			console.log("entrei no fetch")
			if (response.ok) {
				response.json().then(function (resposta) {
					console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
					resposta.reverse();

					plotarGrafico(resposta, id);

				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});

	}



	function plotarGrafico(resposta, id) {

		console.log('iniciando plotagem do gráfico...');

		// Criando estrutura para plotar gráfico - labels
		let labels = [];

		// Criando estrutura para plotar gráfico - dados
		let dados = {
			labels: labels,
			datasets: [{

				label: 'Temperatura',
				data: [],
				fill: false,
				borderColor: 'rgb(199, 52, 52)',
				tension: 0.1

			},
			{
				label: 'Umidade',
				data: [],
				fill: false,
				backgroundColor: "#4761f4",
				borderColor: "#4761f4",
				tension: 0.1

			},]
		};

		let dados2 = {
			labels: labels,
			datasets: [{
				label: 'Temperatura',
				data: [],
				fill: false,
				borderColor: 'rgb(199, 52, 52)',
				tension: 0.1

			}, {
				label: 'Umidade',
				data: [],
				fill: false,
				backgroundColor: "#4761f4",
				borderColor: "#4761f4",
				tension: 0.1
			},]
		};

		let dados3 = {
			labels: labels,
			datasets: [{
				label: 'Temperatura',
				data: [],
				fill: false,
				borderColor: 'rgb(199, 52, 52)',
				tension: 0.1

			}, {
				label: 'Umidade',
				data: [],
				fill: false,
				backgroundColor: "#4761f4",
				borderColor: "#4761f4",
				tension: 0.1
			},]
		}




		console.dir("passei do grafico")


		// labels: labels,
		// datasets: [{
		// 	label: 'Umidade',
		// 	data: [],
		// 	fill: false,
		// 	borderColor: 'rgb(75, 192, 192)',
		// 	tension: 0.1
		// },
		// {
		// 	label: 'Temperatura',
		// 	data: [],
		// 	fill: false,
		// 	borderColor: 'rgb(199, 52, 52)',
		// 	tension: 0.1
		// },];

		console.log('----------------------------------------------')
		console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
		console.log(resposta)

		// Inserindo valores recebidos em estrutura para plotar o gráfico
		for (i = 0; i < resposta.length; i++) {
			var registro = resposta[i];
			labels.push(registro.data_hora);
			dados.datasets[0].data.push(registro.umidade);
			dados2.datasets[0].data.push(registro.temperatura);
			console.dir("inseriu na plotar")
		}


		console.log('----------------------------------------------')
		console.log('O gráfico será plotado com os respectivos valores:')
		console.log('Labels:')
		console.log(labels)
		console.log('Dados:')
		console.log(dados.datasets)
		console.log('----------------------------------------------')

		// Criando estrutura para plotar gráfico - config
		const config = {
			type: 'line',
			data: dados,
			options: {
				scales: {
					yAxes: [{
						ticks: {
							min: 20,
							max: 80
						}
					}],
				}
			}
		};

		const config2 = {
			type: 'line',
			data: dados2,
			options: {
				scales: {
					yAxes: [{
						ticks: {
							min: 0,
							max: 60
						}
					}],
				}
			}
		};

		const config3 = {
			type: 'line',
			data: dados3,
			options: {
				scales: {
					yAxes: [{
						ticks: {
							min: 0,
							max: 60
						}
					}],
				}
			}
		};


		// Adicionando gráfico criado em div na tela
		let myChart = new Chart(
			document.getElementById(`grafico`),
			config
		);
		let myChart2 = new Chart(
			document.getElementById(`grafico2`),
			config2
		);
		let myChart3 = new Chart(
			document.getElementById(`grafico3`),
			config3
		);

		setTimeout(() => atualizarGrafico(id, dados, dados2, dados3, myChart, myChart2, myChart3), 2000);


	}



	function atualizarGrafico(id, dados, dados2, dados3, myChart, myChart2, myChart3) {


		fetch(`/dashboard/atualizarGrafico/${id}`, { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (novoRegistro) {

					// obterdados(id);
					// alertar(novoRegistro, idAquario);
					console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
					console.log(`Dados atuais do gráfico:`);
					console.log(dados);
					// let avisoCaptura = document.getElementById(`avisoCaptura${id}`)
					// avisoCaptura.innerHTML = ""



					if (novoRegistro[0].temperatura > 40 && novoRegistro[0].temperatura < 30) {
						document.getElementById("img1Sala1").src = "./img/tem_mt_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 30 && novoRegistro[0].temperatura < 20) {
						document.getElementById("img1Sala1").src = "./img/temp_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 20 && novoRegistro[0].temperatura < 15) {
						document.getElementById("img1Sala1").src = "./img/temp_controlada.png"
					}
					else if (novoRegistro[0].temperatura >= 15 && novoRegistro[0].temperatura < 5) {
						document.getElementById("img1Sala1").src = "./img/temp_baixa.png"
					}
					else {
						document.getElementById("img1Sala1").src = "./img/temp_mt_baixa.png"
					}


					if (novoRegistro[0].umidade >= 80 && novoRegistro[0].umidade < 60) {
						document.getElementById("img2Sala1").src = "./img/umidade_mt_alta.png"
					}
					else if (novoRegistro[0].umidade >= 60 && novoRegistro[0].umidade < 40) {
						document.getElementById("img2Sala1").src = "./img/umidade_alta.png"
					}
					else if (novoRegistro[0].umidade >= 40 && novoRegistro[0].umidade < 30) {
						document.getElementById("img2Sala1").src = "./img/umidade_controlada.png"
					}
					else if (novoRegistro[0].umidade >= 30 && novoRegistro[0].umidade < 20) {
						document.getElementById("img2Sala1").src = "./img/umidade_baixa.png"
					}
					else {
						document.getElementById("img2Sala1").src = "./img/umidade_mt_baixa.png"
					}








					if (novoRegistro[0].temperatura > 40 && novoRegistro[0].temperatura < 30) {
						document.getElementById("img3Sala2").src = "./img/tem_mt_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 30 && novoRegistro[0].temperatura < 20) {
						document.getElementById("img3Sala2").src = "./img/temp_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 20 && novoRegistro[0].temperatura < 15) {
						document.getElementById("img3Sala2").src = "./img/temp_controlada.png"
					}
					else if (novoRegistro[0].temperatura >= 15 && novoRegistro[0].temperatura < 5) {
						document.getElementById("img3Sala2").src = "./img/temp_baixa.png"
					}
					else {
						document.getElementById("img3Sala2").src = "./img/temp_mt_baixa.png"
					}


					if (novoRegistro[0].umidade >= 80 && novoRegistro[0].umidade < 60) {
						document.getElementById("img4Sala2").src = "./img/umidade_mt_alta.png"
					}
					else if (novoRegistro[0].umidade >= 60 && novoRegistro[0].umidade < 40) {
						document.getElementById("img4Sala2").src = "./img/umidade_alta.png"
					}
					else if (novoRegistro[0].umidade >= 40 && novoRegistro[0].umidade < 30) {
						document.getElementById("img4Sala2").src = "./img/umidade_controlada.png"
					}
					else if (novoRegistro[0].umidade >= 30 && novoRegistro[0].umidade < 20) {
						document.getElementById("img4Sala2").src = "./img/umidade_baixa.png"
					}
					else {
						document.getElementById("img4Sala2").src = "./img/umidade_mt_baixa.png"
					}







					if (novoRegistro[0].temperatura > 40 && novoRegistro[0].temperatura < 30) {
						document.getElementById("img5Sala3").src = "./img/tem_mt_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 30 && novoRegistro[0].temperatura < 20) {
						document.getElementById("img5Sala3").src = "./img/temp_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 20 && novoRegistro[0].temperatura < 15) {
						document.getElementById("img5Sala3").src = "./img/temp_controlada.png"
					}
					else if (novoRegistro[0].temperatura >= 15 && novoRegistro[0].temperatura < 5) {
						document.getElementById("img5Sala3").src = "./img/temp_baixa.png"
					}
					else {
						document.getElementById("img5Sala3").src = "./img/temp_mt_baixa.png"
					}


					if (novoRegistro[0].umidade >= 80 && novoRegistro[0].umidade < 60) {
						document.getElementById("img6Sala3").src = "./img/umidade_mt_alta.png"
					}
					else if (novoRegistro[0].umidade >= 60 && novoRegistro[0].umidade < 40) {
						document.getElementById("img6Sala3").src = "./img/umidade_alta.png"
					}
					else if (novoRegistro[0].umidade >= 40 && novoRegistro[0].umidade < 30) {
						document.getElementById("img6Sala3").src = "./img/umidade_controlada.png"
					}
					else if (novoRegistro[0].umidade >= 30 && novoRegistro[0].umidade < 20) {
						document.getElementById("img6Sala3").src = "./img/umidade_baixa.png"
					}
					else {
						document.getElementById("img6Sala3").src = "./img/umidade_mt_baixa.png"
					}







					if (novoRegistro[0].temperatura > 40 && novoRegistro[0].temperatura < 30) {
						document.getElementById("img7Sala4").src = "./img/tem_mt_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 30 && novoRegistro[0].temperatura < 20) {
						document.getElementById("img7Sala4").src = "./img/temp_alta.png"
					}
					else if (novoRegistro[0].temperatura >= 20 && novoRegistro[0].temperatura < 15) {
						document.getElementById("img7Sala4").src = "./img/temp_controlada.png"
					}
					else if (novoRegistro[0].temperatura >= 15 && novoRegistro[0].temperatura < 5) {
						document.getElementById("img7Sala4").src = "./img/temp_baixa.png"
					}
					else {
						document.getElementById("img7Sala4").src = "./img/temp_mt_baixa.png"
					}


					if (novoRegistro[0].umidade >= 80 && novoRegistro[0].umidade < 60) {
						document.getElementById("img8Sala4").src = "./img/umidade_mt_alta.png"
					}
					else if (novoRegistro[0].umidade >= 60 && novoRegistro[0].umidade < 40) {
						document.getElementById("img8Sala4").src = "./img/umidade_alta.png"
					}
					else if (novoRegistro[0].umidade >= 40 && novoRegistro[0].umidade < 30) {
						document.getElementById("img8Sala4").src = "./img/umidade_controlada.png"
					}
					else if (novoRegistro[0].umidade >= 30 && novoRegistro[0].umidade < 20) {
						document.getElementById("img8Sala4").src = "./img/umidade_baixa.png"
					}
					else {
						document.getElementById("img8Sala4").src = "./img/umidade_mt_baixa.png"
					}




					if (novoRegistro[0].data_hora == dados.labels[dados.labels.length - 1]) {
						console.log("---------------------------------------------------------------")
						console.log("Como não há dados novos para captura, o gráfico não atualizará.")
						// avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
						console.log("Horário do novo dado capturado:")
						console.log(novoRegistro[0].data_hora)
						console.log("Horário do último dado capturado:")
						console.log(dados.labels[dados.labels.length - 1])
						console.log("---------------------------------------------------------------")
					} else {
						// tirando e colocando valores no gráfico
						dados.labels.shift(); // apagar o primeiro new Date(registro.dataHora).toLocaleTimeString()
						dados.labels.push(new Date(novoRegistro[0].data_hora).toLocaleTimeString()); // incluir um novo momento

						dados.datasets[0].data.shift();
						dados.datasets[0].data.push(novoRegistro[0].umidade);
						dados.datasets[0].data.shift();
						dados.datasets[0].data.push(novoRegistro[0].temperatura);

						dados2.datasets[0].data.shift();
						dados2.datasets[0].data.push(novoRegistro[0].temperatura);
						dados2.datasets[0].data.shift();
						dados2.datasets[0].data.push(novoRegistro[0].umidade);

						dados3.datasets[0].data.shift();
						dados3.datasets[0].data.push(novoRegistro[0].temperatura);
						dados3.datasets[0].data.shift();
						dados3.datasets[0].data.push(novoRegistro[0].umidade);

						myChart.update();
						myChart2.update();
						myChart3.update();
					}

					// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
					proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, dados2, dados3, myChart, myChart2, myChart3), 2000);
				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
				// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
				proximaAtualizacao = setTimeout(() => atualizarGrafico(id, dados, myChart), 2000);
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});


	}

	var sala = 0;
	var primeiroRack = 0;
	function fecharSalas() {

		document.getElementById("inputSalas").style.display = 'none'

		if (sala == 0) {

			document.querySelector('.main_sala').style.display = 'flex';
			document.querySelector('.main_salas').style.display = 'none';
			document.querySelector('.salas_titulo').style.display = 'none';
			headerTitulo.innerHTML = 'Sala 1';
			sala++;
		} else {
			document.querySelector('.main_sala').style.display = 'none';
			document.querySelector('.main_salas').style.display = 'flex';
			document.querySelector('.salas_titulo').style.display = 'flex';
			headerTitulo.innerHTML = 'Salas';
			sala--;
		}
	}
	function rack1() {

		if (primeiroRack == 0) {
			primeiroRack++;
			rackNav1.innerHTML = `<img src="./img/minus.png" alt=""></img>`
			document.getElementById("rackDois").style.display = 'none';
			document.getElementById("rackTres").style.display = 'none';
			document.getElementById("rackUm").style.height = '95%';
			document.getElementById("rackMain").style.height = '32%';
			document.getElementById("graficosRacks").style.display = 'flex';
		} else {
			rackNav1.innerHTML = `<img src="./img/plus.png" alt=""></img>`
			document.getElementById("rackDois").style.display = 'block';
			document.getElementById("rackTres").style.display = 'block';
			document.getElementById("rackUm").style.height = '30%';
			document.getElementById("rackMain").style.height = '100%';
			document.getElementById("graficosRacks").style.display = 'none';
			primeiroRack--;
		}
	}
	function rack2() {

		if (primeiroRack == 0) {
			primeiroRack++;
			rackNav2.innerHTML = `<img src="./img/minus.png" alt=""></img>`
			document.getElementById("rackUm").style.display = 'none';
			document.getElementById("rackTres").style.display = 'none';
			document.getElementById("rackDois").style.height = '95%';
			document.getElementById("rackMain2").style.height = '32%';
			document.getElementById("graficosRacks2").style.display = 'flex';
		} else {
			rackNav2.innerHTML = `<img src="./img/plus.png" alt=""></img>`
			document.getElementById("rackUm").style.display = 'block';
			document.getElementById("rackTres").style.display = 'block';
			document.getElementById("rackDois").style.height = '30%';
			document.getElementById("rackMain2").style.height = '100%';
			document.getElementById("graficosRacks2").style.display = 'none';
			primeiroRack--;
		}
	}
	function rack3() {

		if (primeiroRack == 0) {
			primeiroRack++;
			rackNav3.innerHTML = `<img src="./img/minus.png" alt=""></img>`
			document.getElementById("rackDois").style.display = 'none';
			document.getElementById("rackUm").style.display = 'none';
			document.getElementById("rackTres").style.height = '95%';
			document.getElementById("rackMain3").style.height = '32%';
			document.getElementById("graficosRacks3").style.display = 'flex';
		} else {
			rackNav3.innerHTML = `<img src="./img/plus.png" alt=""></img>`
			document.getElementById("rackDois").style.display = 'block';
			document.getElementById("rackUm").style.display = 'block';
			document.getElementById("rackTres").style.height = '30%';
			document.getElementById("rackMain3").style.height = '100%';
			document.getElementById("graficosRacks3").style.display = 'none';
			primeiroRack--;
		}
	}


</script>